---
title: "Intro to SFAplus package"
author: "Vaclav Hausenblas"
date: "2016-04-01"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  ---
  
  This document shows and test basic routines of SFAplus package.
  
  ```{r}
# require(SFAplus)
# require(msm) # package for drawing from truncated-normal distribution
# require(data.table) # for more convenient data manipulation
```


### Example dataset

Lets generate some randomly simulated production data,

```{r}
source("simulate_data.R")

data1 <- as.data.frame(sim_data(500))

```

and explore the production data and simulated inefficiency term.

```{r}
# require(GGally)
# ggpairs(dtDT)

plot(data1)
hist(data1$y)
hist(data1$u)
hist(data1$eps)

```
## SFA -- normal/t-normal model

```{r}

SFAplus::sfa.fit(y = data1$y,
                 X = cbind(data1$x1, data1$x2),
                 Z = NULL,       
                 spec  = NULL,
                 deb = T
                 # control_opt = list(maxit = 300)
)

```


## SFA model with endogenous inefficiency mean 

```{r}

est <- SFAplus::sfa.fit(y = data1$y,
                        X = cbind(data1$x1, data1$x2),
                        Z = cbind(data1$z1, data1$z2),
                        spec  = "bc95",
                        deb = F
                        # control_opt = list(maxit = 300)
)

print(est)
```


## OLS model

We might be interested in simple OLS model for LR test (and starting values of parameters).

```{r}

lmfit <- lm(y ~ x1 + x2 + I(-z1) + I(-z2), data = data1)
summary(lmfit)

```





<!-- # BOUNDS ------------------------------------------------------------------ -->
<!-- # set lower bounds, important for sigmas -->
<!-- lowerb <- c(-Inf, -Inf, -Inf, -Inf, -Inf, -Inf, -Inf, 0.0001, 0.0001) -->

<!-- # initpar = c(lmfit$coefficients[1:4], 0, lmfit$coefficients[5:6], 1, 1) -->
<!-- # OR -->
<!-- initpar = c(rep(0, 4+3), 1, 1) -->


<!-- # estimate by BFGS method with bounds -->
<!-- est <- optim(initpar, fn = ll, method = "BFGS", control = list(trace = F, REPORT = 1, maxit = 300), hessian = T, -->
<!--              nbeta = 4, ngamma = 3, -->
<!--              y = dtDT$y, -->
<!--              X = as.matrix(dtDT[, .(1, x1, x2, x1x2)]), -->
<!--              Z = as.matrix(dtDT[, .(1, z1, z2)])) -->
<!-- print(est) -->


## Test statistics 

Compute test statistics for coefficients
```{r}

var_beta <- diag(solve(est$hessian))

tstats <- est$coeff/sqrt(var_beta)

pvalues <- 2 * pt(q = abs(tstats), 
                  df = est$N - length(est$par)+3,
                  lower.tail = FALSE)

coef.table <- round(cbind(est$coeff, 
                          sqrt(var_beta), 
                          tstats, 
                          pvalues), 
                    3)
colnames(coef.table) <- c("Estimate", "Std. Error","t-stat", "Pr(>|t|)")
row.names(coef.table) <- names(est$coeff)

coef.table
```

LR ratio test of model specification.
```{r}
ll_sfa <- -est$loglik
ll_ols <- logLik(lmfit)
LR_test_stat <- 2*(ll_sfa - ll_ols)[1]
chisq_df <- (4+3+2) - attributes(logLik(lmfit))$df
p_value <- pchisq(LR_test_stat, chisq_df, lower.tail = FALSE)

print(LR_test_stat)
print(p_value)
```


