---
title: "Intro to SFAplus package"
author: "Vaclav Hausenblas"
date: "2016-04-01"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  ---
  
```{r Init}
require(SFAt)
# require(msm) # package for drawing from truncated-normal distribution
# require(data.table) # for more convenient data manipulation
```


## Basic SFA models

### Example dataset

Lets generate some randomly simulated production data,

```{r}
data_ex1 <- as.data.frame(sim_data_cs(1000, 
                                      x_coeff = c(50, 4, 2), 
                                      z_coeff = c(20), 
                                      sigma_u = 10, sigma_v = 5))

```

and explore the production data and simulated inefficiency term.

```{r}
# require(GGally)
# ggpairs(dtDT)

plot(data_ex1)
hist(data_ex1$y)
hist(data_ex1$u)
hist(data_ex1$eps)

```

## SFA -- normal/t-normal model

```{r}
model_ex1 <- sfa.fit(y = data_ex1$y,
                     X = cbind(a = data_ex1$x1, b = data_ex1$x2),
                     CM = NULL,   
                     dist = "tnorm",
                     spec = "bc95",
                     opt_control = list(temp = 1, maxit = 6e4)
                     # deb = T, debll = T
)

print(summary(model_ex1))
print(lrtest(model_ex1))
```


```{r}
ineff_fit <- inefficiencyTerm(model_ex1, estimator = "JLMS")
hist(ineff_fit)
```

Check for separation of frontier and actual production data
```{r}
pr <- predict(model_ex1, type = "frontier")
hist(pr, xlim = c(0, max(data_ex1$y)))
hist(data_ex1$y, xlim = c(0, max(data_ex1$y)))
```

```{r}
eff_scaled <- (pr - ineff_fit)/pr
hist(eff_scaled)
```

```{r}
ineff_scaled <- 1-eff_scaled
hist(ineff_scaled)
```

```{r}
hist(efficiency(model_ex1))
```

## SFA model with endogenous inefficiency mean 

### Generate random cross-section dataset
```{r}
data_ex2_cm <- as.data.frame(sim_data_cs(1000, 
                                         x_coeff = c(50, 4, 2), 
                                         z_coeff = c(20, -2, 2), 
                                         sigma_u = 10, sigma_v = 5))

```

### Fit BC95 model
```{r}

model_ex2 <- sfa.fit(y = data_ex2_cm$y,
                     X = cbind(a = data_ex2_cm$x1, b = data_ex2_cm$x2),
                     CM = cbind(c = data_ex2_cm$z1, d = data_ex2_cm$z2),
                     dist = "tnorm",
                     spec  = "bc95",
                     # deb = T, debll = T,
                     opt_method = "SANN",
                     opt_control = list(maxit = 50e3))

# print(model_ex2$coeff_frontier)
# print(model_ex2$coeff_cm)
# print(model_ex2$coeff_cv_u)
# print(model_ex2$coeff_cv_v)
print(summary(model_ex2))
print(lrtest(model_ex2))
```

### Fitted inefficiency term ($E(u_i|\epsilon_i)$)

```{r}
ex2_ineff_term <- predict(model_ex2, 
                          type = "inefficiency", 
                          estimator = "JLMS")

hist(ex2_ineff_term)
```

### Fitted efficiency (%)
```{r}
ex2_efficiencies <- predict(model_ex2, 
                            type = "efficiency", 
                            estimator = "JLMS")

hist(ex2_efficiencies)
```



<!-- ## OLS model -->

<!-- We might be interested in simple OLS model for skew test / LR test (and starting values of parameters). -->

<!-- ```{r} -->

<!-- lmfit <- lm(y ~ x1 + x2 + I(-z1) + I(-z2), data = data_ex2_cm) -->
<!-- summary(lmfit) -->

<!-- ``` -->


