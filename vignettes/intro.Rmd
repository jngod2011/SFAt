---
title: "Intro to SFAplus package"
author: "Vaclav Hausenblas"
date: "2016-04-01"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  ---
  
  This document shows and test basic routines of SFAplus package.
  
  ```{r}
# require(SFAplus)
# require(msm) # package for drawing from truncated-normal distribution
# require(data.table) # for more convenient data manipulation
```


### Example dataset

Lets generate some randomly simulated production data,

```{r}
# source("simulate_data.R")
require(SFAt)
data1 <- as.data.frame(sim_data_cs(1000, 
                                   x_coeff = c(50, 4, 2), 
                                   z_coeff = c(20), 
                                   sigma_u = 20, sigma_v = 5))

```

and explore the production data and simulated inefficiency term.

```{r}
# require(GGally)
# ggpairs(dtDT)

# plot(data1)
hist(data1$y)
# hist(data1$u)
# hist(data1$eps)

```
## SFA -- normal/t-normal model

```{r}

sfa1 <- SFAt::sfa.fit(y = data1$y,
                      X = cbind(a = data1$x1, b = data1$x2),
                      CM = NULL,    
                      dist = "tnorm",
                      spec  = NULL,
                      deb = F,
                      opt_method = "SANN"
                      # control_opt = list(maxit = 300)
)

summary(sfa1)
```


```{r}
ineff_fit <- inefficiencyTerm(sfa1, estimator = "JLMS")
hist(ineff_fit)
```

Check for separation of frontier and actual production data
```{r}
pr <- predict(sfa1, type = "frontier")
hist(pr, xlim = c(0, max(data1$y)))
hist(data1$y, xlim = c(0, max(data1$y)))
```

```{r}
eff_scaled <- (pr - ineff_fit)/pr
hist(eff_scaled)
```

```{r}
ineff_scaled <- 1-eff_scaled
hist(ineff_scaled)
```

```{r}
hist(efficiency(sfa1))
```

## SFA model with endogenous inefficiency mean 

```{r}
data2 <- as.data.frame(sim_data_cs(1000, 
                                   x_coeff = c(50, 4, 2), 
                                   z_coeff = c(20, -2, 2), 
                                   sigma_u = 10, sigma_v = 5))

```

```{r}

est <- SFAt::sfa.fit(y = data2$y,
                     X = cbind(a = data2$x1, b = data2$x2),
                     CM = cbind(c = data2$z1, d = data2$z2),
                     dist = "tnorm",
                     spec  = "bc95",
                     deb = F,
                     opt_method = "L-BFGS-B",
                     control_opt = list(maxit = 6000)
)

est$coefficients
est$coefficients_Z
summary(est)
```

```{r}
hist(SFAt:::u_cs_tnorm_bc95(est, "BC"))
```


## OLS model

We might be interested in simple OLS model for LR test (and starting values of parameters).

```{r}

lmfit <- lm(y ~ x1 + x2 + I(-z1) + I(-z2), data = data1)
summary(lmfit)

```


